#! /bin/sh

identify_proposals()
{
	for filename in `ls /usr/share/tiva/proposals/news`
	do
		[ -f /usr/share/tiva/proposals/news/$filename ] || continue
		[ `stat -c %u /usr/share/tiva/proposals/news/$filename` -ne 0 ] || continue
		prepare_proposal $filename
	done
}

prepare_proposal()
{
	author=`stat -c %U /usr/share/tiva/proposals/news/$1`
	chown root.root /usr/share/tiva/proposals/news/$1
	mv /usr/share/tiva/proposals/news/$1 /usr/share/tiva/proposals/$1
	sed -i "s/^#\*/#X\*/g" /usr/share/tiva/proposals/$1
	id=`cat /dev/urandom | tr -dc a-zA-Z0-9 | head -c 10`
	mv /usr/share/tiva/proposals/$1 /usr/share/tiva/proposals/$id
	sed -i "2i#* Title: `echo $1 | sed \"s/_/ /g\" | sed \"s/\(.\)/\U\1/\"`" /usr/share/tiva/proposals/$id
	sed -i "3i#* Author: $author" /usr/share/tiva/proposals/$id
	sed -i "4i#* Creation date: `date`" /usr/share/tiva/proposals/$id
	sed -i "5i#* Approved by: " /usr/share/tiva/proposals/$id
}

identify_actions()
{
	for filename in `ls /usr/share/tiva/proposals/actions`
	do
		proposal=`echo $filename | sed -e "s/approve_\(.\+\)/\1/g"`
		author=`stat -c %U /usr/share/tiva/proposals/actions/$filename`
		if [ `groups $author | sed -e "s/.*:.*tiva_manager.*/0/g"` -eq 0 ]
		then
			sed -i "5s/\(.*\)/\1$author;/" /usr/share/tiva/proposals/$proposal
			rm /usr/share/tiva/proposals/actions/$filename
		fi
	done
}

identify_proposals
identify_actions
